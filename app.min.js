const CLINIC={whatsapp:'5512999999999',phoneText:'(12) 0000-0000',siteUrl:'https://clinicamedicaatos.com.br/'};
const $=s=>document.querySelector(s),$$=s=>Array.from(document.querySelectorAll(s));

// Menu + teclado
const menuBtn=$('#menuBtn'),menu=$('#menu');
menuBtn?.addEventListener('click',()=>{const o=menu.classList.toggle('open');menuBtn.setAttribute('aria-expanded',String(o));if(o)menu.querySelector('a')?.focus();});
menuBtn?.addEventListener('keydown',e=>{if(e.key==='Enter'||e.key===' '){e.preventDefault();menuBtn.click();}});
document.addEventListener('keydown',e=>{if(e.key==='Escape')menu.classList.remove('open');});
$$('#menu a').forEach(a=>a.addEventListener('click',()=>menu.classList.remove('open')));

// Scrollspy
const sections=['home','clinica','equipe','servicos','faq','contato'].map(id=>document.getElementById(id));
const navLinks=$$('#menu a[href^="#"]');
const IO=new IntersectionObserver(es=>{es.forEach(en=>{const id=en.target.id;const l=navLinks.find(x=>x.getAttribute('href')==='#'+id);if(l)l.setAttribute('aria-current',en.isIntersecting?'page':null);});},{rootMargin:'-50% 0px -49% 0px',threshold:.01});
sections.forEach(s=>s&&IO.observe(s));

// Carrossel acessível
const slidesEl=$('#slides'),dots=$$('.dots button');let idx=0,auto;
function go(i){idx=i;slidesEl.style.transform=`translateX(-${i*100}%)`;dots.forEach((d,n)=>d.classList.toggle('active',n===i));}
dots.forEach((d,i)=>d.addEventListener('click',()=>go(i)));
function autoplay(){if(window.matchMedia('(prefers-reduced-motion: reduce)').matches)return;auto=setInterval(()=>go((idx+1)%dots.length),6000);}
autoplay();

// FAB WhatsApp
const waBtn=$('#waBtn');function refreshWA(){waBtn.href=`https://wa.me/${CLINIC.whatsapp}?text=${encodeURIComponent('Olá! Gostaria de agendar uma consulta pela Clínica Médica Atos.')}`;}refreshWA();

// ToTop
const toTop=$('#toTop');window.addEventListener('scroll',()=>toTop.classList.toggle('show',window.scrollY>600));toTop.querySelector('button')?.addEventListener('click',()=>window.scrollTo({top:0,behavior:'smooth'}));

// Modais
const policyModal=$('#policyModal'),termsModal=$('#termsModal');
$('#openPolicy')?.addEventListener('click',e=>{e.preventDefault();policyModal.showModal();});
$('#policyLink')?.addEventListener('click',e=>{e.preventDefault();policyModal.showModal();});
$('#termsLink')?.addEventListener('click',e=>{e.preventDefault();termsModal.showModal();});

// Wizard
const form=$('#formAgenda'),steps=Array.from(form.querySelectorAll('[data-step]'));
const stepEls=[$('#s1'),$('#s2'),$('#s3')];let current=1;
const prevBtn=$('#prevBtn'),nextBtn=$('#nextBtn'),submitBtn=$('#submitBtn'),spinner=$('#spinner'),review=$('#review'),feedback=$('#feedback'),toast=$('#toast');
function showStep(n){current=n;steps.forEach((sec,i)=>sec.hidden=(i+1)!==n);stepEls.forEach((el,i)=>el.classList.toggle('active',(i+1)===n));prevBtn.disabled=n===1;nextBtn.hidden=n===3;submitBtn.hidden=n!==3;feedback.textContent='';if(n===3){const nome=$('#nome').value.trim(),tel=$('#tel').value.trim(),prof=$('#prof').value,tipo=$('#tipo').value,data=$('#data').value,hora=document.querySelector('.slot.active')?.textContent||'',msg=$('#msg').value.trim();review.innerHTML=`<strong>Nome:</strong> ${nome}<br><strong>Contato:</strong> ${tel}<br><strong>Profissional:</strong> ${prof}<br><strong>Tipo:</strong> ${tipo}<br><strong>Data/Hora:</strong> ${data} ${hora||''}<br><strong>Observações:</strong> ${msg||'-'}`;}}
prevBtn.addEventListener('click',()=>showStep(Math.max(1,current-1)));
nextBtn.addEventListener('click',()=>{if(validateCurrent())showStep(Math.min(3,current+1));});
showStep(1);

// Máscara telefone
const tel=$('#tel');tel.addEventListener('input',()=>{const v=tel.value.replace(/\D/g,'');let m=v;if(v.length>0)m='('+v.substring(0,2);if(v.length>=3)m+=') '+v.substring(2,3)+' ';if(v.length>=7)m+=v.substring(3,7)+'-'+v.substring(7,11);else if(v.length>3)m+=v.substring(3,7);tel.value=m;});

// Validação em tempo real
function errMsg(id){switch(id){case'nome':return'Informe seu nome completo.';case'tel':return'Informe um número válido com DDD.';case'prof':return'Selecione o profissional.';case'tipo':return'Selecione o tipo de consulta.';case'data':return'Escolha uma data válida.';case'lgpd':return'É necessário aceitar a política de privacidade.';default:return'Campo obrigatório.';}}
function validateField(id){const el=$('#'+id);if(!el)return!0;const wrap=el.closest('.field')||el.parentElement,err=document.querySelector(`[data-err="${id}"]`);let ok=!!el.value;if(id==='tel')ok=el.value.replace(/\D/g,'').length>=11;if(id==='data')ok=!!el.value&&new Date(el.value)>=new Date(new Date().toDateString());wrap?.classList.toggle('invalid',!ok);if(err)err.textContent=ok?'':errMsg(id);return ok;}
['nome','tel','prof','tipo','data'].forEach(id=>{const el=$('#'+id);el?.addEventListener('blur',()=>validateField(id));el?.addEventListener('change',()=>validateField(id));el?.addEventListener('input',()=>validateField(id));});
function validateCurrent(){if(current===1)return validateField('nome')&validateField('tel');if(current===2)return validateField('prof')&validateField('tipo')&validateField('data');return!0;}

// Calendário + slots
const calTitle=$('#calTitle'),calGrid=$('#calGrid'),prevCal=$('#prevCal'),nextCal=$('#nextCal'),dataInp=$('#data'),slotsBox=$('#slots');
let view=new Date();view.setDate(1);
function weekdaySlots(d){return{0:[],1:['08:00','09:40','11:20','14:00','15:40','17:20'],2:['08:00','09:40','11:20','14:00','15:40','17:20'],3:['08:00','09:40','11:20','14:00','15:40'],4:['08:00','09:40','11:20','14:00','15:40','17:20'],5:['08:00','09:40','11:20'],6:[]}[d]||[];}
function renderCalendar(){const y=view.getFullYear(),m=view.getMonth();calGrid.innerHTML='';const monthName=view.toLocaleString('pt-BR',{month:'long',year:'numeric'});calTitle.textContent=monthName[0].toUpperCase()+monthName.slice(1);['D','S','T','Q','Q','S','S'].forEach(h=>{const d=document.createElement('div');d.textContent=h;d.className='hd';calGrid.appendChild(d);});const fw=new Date(y,m,1).getDay(),dim=new Date(y,m+1,0).getDate();for(let i=0;i<fw;i++){const c=document.createElement('div');c.className='cal-day disabled';calGrid.appendChild(c);}for(let day=1;day<=dim;day++){const date=new Date(y,m,day);const c=document.createElement('div');c.className='cal-day';c.tabIndex=0;const dow=date.getDay();const avail=weekdaySlots(dow);const today=new Date(new Date().toDateString());const isPast=date<today;if(isPast||avail.length===0)c.classList.add('disabled');c.innerHTML=`<div aria-hidden="true">${day}${avail.length&&!isPast?'<span class="dot"></span>':''}</div>`;c.addEventListener('click',()=>selectDate(date,c,avail));c.addEventListener('keydown',e=>{if(e.key==='Enter'&&!c.classList.contains('disabled'))selectDate(date,c,avail);});calGrid.appendChild(c);}const init=new Date();if(weekdaySlots(init.getDay()).length)selectDate(init,null,weekdaySlots(init.getDay()));}
function selectDate(date,cell,avail){if(cell&&cell.classList.contains('disabled'))return;dataInp.value=date.toISOString().slice(0,10);document.querySelectorAll('.cal-day').forEach(c=>c.classList.remove('selected'));if(cell)cell.classList.add('selected');renderSlots(avail);}
function renderSlots(list){slotsBox.innerHTML='';list.forEach(t=>{const b=document.createElement('button');b.type='button';b.className='slot';b.setAttribute('aria-label','Horário '+t);b.textContent=t;b.addEventListener('click',()=>{document.querySelectorAll('.slot').forEach(x=>x.classList.remove('active'));b.classList.add('active');});slotsBox.appendChild(b);});if(!list.length)slotsBox.innerHTML='<span class="helper">Sem horários neste dia. Escolha outra data.</span>'; }
prevCal.addEventListener('click',()=>{view.setMonth(view.getMonth()-1);renderCalendar();});nextCal.addEventListener('click',()=>{view.setMonth(view.getMonth()+1);renderCalendar();});renderCalendar();
dataInp.addEventListener('change',()=>{const d=new Date(dataInp.value);if(isNaN(d))return;view=new Date(d.getFullYear(),d.getMonth(),1);renderCalendar();const cell=Array.from(document.querySelectorAll('.cal-day')).find(c=>c.textContent.trim().startsWith(String(d.getDate())));const avail=weekdaySlots(d.getDay());if(cell){cell.classList.add('selected');renderSlots(avail);}});

// Submit + LGPD
form.addEventListener('submit',e=>{e.preventDefault();const ok=validateField('nome')&validateField('tel')&validateField('prof')&validateField('tipo')&validateField('data');const lgpd=$('#lgpd');if(!lgpd.checked){document.querySelector('[data-err="lgpd"]').textContent=errMsg('lgpd');return;}if(!ok)return;spinner.hidden=false;$('#submitTxt').textContent='Enviando...';const texto=`Olá! Quero solicitar agendamento:%0A• Nome: ${$('#nome').value.trim()}%0A• Contato: ${$('#tel').value.trim()}%0A• Profissional: ${$('#prof').value}%0A• Tipo: ${$('#tipo').value}%0A• Data/Horário: ${$('#data').value} ${document.querySelector('.slot.active')?.textContent||''}%0A• Observações: ${$('#msg').value.trim()||'-'}%0A(Enviado pelo site)`;window.open(`https://wa.me/${CLINIC.whatsapp}?text=${texto}`,'_blank','noopener');spinner.hidden=true;$('#submitTxt').textContent='Solicitar agendamento';saveDraft();toast.classList.add('show');setTimeout(()=>toast.classList.remove('show'),4500);form.reset();localStorage.removeItem('atos_draft');showStep(1);});

// Autosave draft + restore
const DRAFT_KEY='atos_draft';
function saveDraft(){const data={nome:$('#nome').value,tel:$('#tel').value,prof:$('#prof').value,tipo:$('#tipo').value,data:$('#data').value,hora:document.querySelector('.slot.active')?.textContent||'',msg:$('#msg').value,lgpd:$('#lgpd')?.checked||false};localStorage.setItem(DRAFT_KEY,JSON.stringify(data));feedback.textContent='Rascunho salvo.';setTimeout(()=>feedback.textContent='',2000);}
$$('#formAgenda input, #formAgenda select, #formAgenda textarea').forEach(el=>el.addEventListener('input',()=>saveDraft()));
$('#saveDraftBtn')?.addEventListener('click',()=>{saveDraft();alert('Salvo! Você pode voltar depois e continuar.');});
(function restoreDraft(){try{const d=JSON.parse(localStorage.getItem(DRAFT_KEY)||'null');if(!d)return;$('#nome').value=d.nome||'';$('#tel').value=d.tel||'';$('#prof').value=d.prof||'';$('#tipo').value=d.tipo||'';$('#data').value=d.data||'';$('#msg').value=d.msg||'';if(d.data){const dt=new Date(d.data);view=new Date(dt.getFullYear(),dt.getMonth(),1);renderCalendar();}if(d.hora){renderSlots(weekdaySlots(new Date($('#data').value).getDay()));const s=Array.from(document.querySelectorAll('.slot')).find(x=>x.textContent===d.hora);s?.classList.add('active');}if(d.lgpd)$('#lgpd').checked=true;}catch(_){}})();

// Exportar endereço
const gmaps=$('#gmaps'),waze=$('#waze');if(gmaps)gmaps.href='https://www.google.com/maps/dir/?api=1&destination=Av.+Tiradentes,+169,+Taubaté,+SP,+12030-180';if(waze)waze.href='https://waze.com/ul?ll=-23.017,-45.555&navigate=yes';

// Depoimentos: coleta p/ moderação (local)
const depoForm=$('#depoForm');depoForm?.addEventListener('submit',e=>{e.preventDefault();const n=$('#depoNome').value.trim(),t=$('#depoTexto').value.trim();if(!n||!t)return;const arr=JSON.parse(localStorage.getItem('atos_depo_pending')||'[]');arr.push({nome:n,texto:t,date:Date.now()});localStorage.setItem('atos_depo_pending',JSON.stringify(arr));e.target.reset();alert('Recebemos seu depoimento! Publicaremos após moderação.');});

// Ano rodapé
$('#year').textContent=new Date().getFullYear();